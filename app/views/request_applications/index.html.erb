<p id="notice"><%= notice %></p>

<h1>Listing Request Applications</h1>

<table class="table">
  <thead>
    <tr>
      <th>Management no</th>
      <th>Project</th>
      <th>E!</th>
      <th>Filename</th>
      <th>Request date</th>
      <th>Preferred date</th>
      <th>Close</th>
      <th>|</th>
         <% @flow_orders.each do |flow_order| %>
        <th>
          <%= flow_order.dept.try(:name).presence || "プロジェクト" %>
        </th>
         <% end %>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <% @request_applications.each do |request_application| %>
      <tr>
        <td><%= request_application.management_no %></td>
        <td><%= request_application.project.try(:name) %></td>
        <td><%= "緊急" if request_application.emargency %></td>
        <td><%= (link_to "Download" , request_application.filename_url) if request_application.filename_url.present? %></td>
        <td><%= request_application.request_date %></td>
        <td><%= request_application.preferred_date %></td>
        <td><%= request_application.close_status %></td>
        <td>|</td>
        <% request_application.flows.latest_flows(request_application.id).each do |flow| %>
        <td>
          <%= flow.progress.try(:in_date) || (link_to 'Start', regist_progress_path((request_application))) %><br>
          <%= ( flow.progress.try(:out_date) || (link_to 'End', regist_progress_path((request_application))) ) unless flow.progress.try(:in_date).blank? %> 
        </td>
         <% end %>
         <% (@flow_orders.count - request_application.flows.maximum(:order)).times do %>
          <td></td>
         <% end %>
        <td><%= link_to 'Show', request_application %>
        <%= (link_to 'Edit', edit_request_application_path(request_application)) unless request_application.close? %>
        <%= (link_to 'Destroy', request_application, method: :delete, data: { confirm: 'Are you sure?' })  if request_application.delete_permit? %>
      </td>
        <td><%= link_to "差戻" , reject_progress_path(request_application) if request_application.flows.order(:history_no).last.reject? %></td>
        <td><%= link_to "中断" , root_path  if request_application.interrupt_permit? %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Request application', new_request_application_path %>
